/*
-------------------------------------------------------------------------------------------------------------------------------------------- 
LIBRARIES 
--------------------------------------------------------------------------------------------------------------------------------------------
*/ 
#define STM32F051 
#include <stm32f0xx.h>
#include <stm32f051x8.h>

/*
-------------------------------------------------------------------------------------------------------------------------------------------- 
DEFINES 
--------------------------------------------------------------------------------------------------------------------------------------------
*/ 

 
/*
-------------------------------------------------------------------------------------------------------------------------------------------- 
GLOBAL VARIABLES 
------------------------------------------------------------------------------------------------------------------------------------------
*/ 

 

/*
-------------------------------------------------------------------------------------------------------------------------------------------- 
FUNCTIONS DECLARATIONS 
--------------------------------------------------------------------------------------------------------------------------------------------
*/ 
void main(void); 
void init_GPIOB(void); 
void init_PWM(void); 

/*
-------------------------------------------------------------------------------------------------------------------------------------------- 
MAIN FUNCTION 
--------------------------------------------------------------------------------------------------------------------------------------------
*/ 

void main(void) { 

    init_GPIOB();
    init_PWM();

    while(1) {
        /* increase LED brightness(duty cycle) from 0 to 100 then back - infinitely */
        for ( int i = 0; i < 8000; i++ ) {
            TIM3 -> CCR3 = i;
        }
        for ( int j = 8000; j > 0; j-- ) {
            TIM3 -> CCR3 = j;
        }
    } 

} 

/*
-------------------------------------------------------------------------------------------------------------------------------------------- 
FUNCTIONS DEFINITIONS 
--------------------------------------------------------------------------------------------------------------------------------------------
*/ 

void init_GPIOB(void) { 
    RCC -> AHBENR |= RCC_AHBENR_GPIOBEN; // enable clock signal to Port B

    /* configure pin PB0 to alternate function mode */
    GPIOB -> MODER |= GPIO_MODER_MODER0_1;
    GPIOB -> MODER &= ~(GPIO_MODER_MODER0_0);
} 

void init_PWM(void) { 
    RCC -> APB13NR |= RCC_APB13NR_TIM3EN; // connect clock signal to PB0 PWM timer[TIM3]
    GPIOB -> AFR[0] |= (0b0001 << (0)*4); // enable PB0 PWM timer channel [TIM3_CH3]
    TIM3 -> ARR = 7999; // set PWM frequency to 1 kHz
    TIM3 -> CCMR2 |= (TIM3_CCMR2_OC3M_2 | TIM3_CCMR2_OC3M_1); // config PWM mode on TIM3_CH3 to normally high
    TIM3 -> CCR3 = 0; // set intial duty cycle to 0%
    TIM3 -> CR1 |= TIM3_CR1_CEN; // start TIM3 counter
}